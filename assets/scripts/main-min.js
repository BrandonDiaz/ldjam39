function gameLoop(){window.timer++;var e=Math.floor(window.timer/60),t=window.timer-60*e;$("#game .time").text((e>10?e:("0"+e).slice(-2))+":"+("0"+t).slice(-2))}function checkTip(e){window.tips[e]&&(queueTips(window.tips[e]),delete window.tips[e])}function queueTips(e){var t=window.tipQueue.length;e.forEach(function(e){window.tipQueue.push(e)}),t||nextTip()}function nextTip(){if(clearTimeout(window.tipTimer),$("#drone").attr("tip",""),window.tipQueue.length){var e=window.tipQueue.shift();$("#drone").attr("tip",e),playSound("tip"),window.tipTimer=setTimeout(function(){nextTip()},1e3+60*e.length)}}function unpowerEntities(){for(var e in window.entities){var t=window.entities[e];t.power=0,t.powered=t.power==t.input,t.overpowered=t.power>t.input,"generator"!=t.type&&t.output&&(t.output=0)}}function powerEntities(){unpowerEntities();for(var e in window.entities){var t=window.entities[e];"generator"==t.type&&distributePower(t)}}function distributePower(e){var t=[],i={north:"south",south:"north",east:"west",west:"east"};for(var o in e.links)if(e.links[o]&&o!=i[e.heading]){var n=crawlCable(e.x,e.y,o,e.x,e.y);n&&n.input&&t.push(n)}t.forEach(function(i){i.power+=Math.floor(e.output/t.length),"resistor"==i.type&&(i.output=Math.max(0,i.power-4)),i.powered=i.power==i.input,i.overpowered=i.power>i.input,i.overpowered&&checkTip("overpowered"),i.output&&distributePower(i)})}function crawlCable(e,t,i,o,n){var w={north:"south",south:"north",east:"west",west:"east"};if(window.entities[e+","+t].input&&e!=o&&t!=n)return window.entities[e+","+t].heading=i,window.entities[e+","+t];if("north"==i&&(t-=1),"south"==i&&(t+=1),"west"==i&&(e-=1),"east"==i&&(e+=1),window.entities[e+","+t]){if(window.entities[e+","+t].input)return window.entities[e+","+t].heading=i,window.entities[e+","+t];for(var s in window.entities[e+","+t].links)if(window.entities[e+","+t].links[s]&&s!=w[i])return crawlCable(e,t,s,o,n)}return null}function linkEntities(){for(var e in window.entities){var t=window.entities[e],i={north:window.entities[t.x+","+(t.y-1)],south:window.entities[t.x+","+(t.y+1)],east:window.entities[t.x+1+","+t.y],west:window.entities[t.x-1+","+t.y]};t.link_count=0,t.links={north:!1,south:!1,east:!1,west:!1};for(var o in i)i[o]&&"tree"!=i[o].type.substring(0,4)&&(t.links[o]=!0,t.link_count++)}}function updateEntities(){var e=!0;linkEntities(),powerEntities();for(var t in window.entities){var i=window.entities[t],o=t.split(",")[0],n=t.split(",")[1],w=$('.entity[x="'+o+'"][y="'+n+'"]');if(w.attr("power",0|i.power),w.attr("input",i.input||0),w.attr("output",i.output||0),w.attr("powered",i.powered||"false"),w.attr("overpowered",i.overpowered||"false"),"house"!=i.type||i.powered||(e=!1),i.links)for(var s in i.links)w.attr("linked-"+s,i.links[s])}e&&(clearInterval(window.tick),window.tipQueue=[],window.map.level==window.level&&(window.level==window.levels.length&&$("#gameover").addClass("visible"),window.level++,window.localStorage.setItem("ld39_current_level",window.level)),loadLevels(),$("#alert").addClass("visible").find("b").text($("#game .time").text()),playSound("complete"))}function playMusic(){var e=["track_1","track_2","track_3","track_4","track_5"];window.mute.music||(window.music=new Howl({src:["assets/music/"+e[Math.floor(Math.random()*e.length)]+".mp3"],autoplay:!0,volume:.2,onend:function(){playMusic()}}))}function playSound(e){if(!window.mute.sound){var e=new Howl({src:["assets/sounds/"+e+".wav"],volume:.5});e.play()}}function loadLevels(){var e=$(".levels");e.empty(),window.levels.forEach(function(t,i){e.append('<li complete="'+(window.level>i+1?"true":"false")+'" unlocked="'+(window.level>=i+1)+'" size="'+(t.height+t.width)+'" style="left: '+t.x+"px; top: "+t.y+'px;"><b>'+(i+1)+"</b> "+t.name+"</li>")})}function loadLevel(e){var t=$("#game .grid"),i=$("#game .tools"),o=window.levels[e];o.level=e+1,t.empty(),i.empty(),t.css({height:48*o.height+"px",width:48*o.width+"px"});for(var n=0;n<o.height;n++)for(var w=0;w<o.width;w++)t.append('<div class="tile" x="'+w+'" y="'+n+'" style="left: '+48*w+"px; top: "+48*n+'px;"></div>');window.tipQueue=[],window.entities={},o.entities.forEach(function(e){window.entities[e.x+","+e.y]=e,t.append('<div class="entity" input="'+(e.input||"")+'" power="0" output="'+(e.output||"")+'" type="'+e.type+'" x="'+e.x+'" y="'+e.y+'" style="left: '+48*e.x+"px; top: "+48*e.y+'px;"></div>')}),o.tools.forEach(function(e){i.append('<li count="'+e.count+'" type="'+e.type+'"></li>')}),window.timer=0,window.tick=setInterval(gameLoop,1e3),window.map=o,window.chirpTimer=Math.round(30*Math.random()+30),queueTips(o.tips)}window.timer=0,window.level=parseInt(window.localStorage.getItem("ld39_current_level"))||1,window.map=null,window.tick=null,window.tool=null,window.entities={},window.tipQueue=[],window.tipTimer=null,window.chirpTimer=null,window.music=null,window.mute={music:!!window.localStorage.getItem("ld39_mute_music")||!1,sound:!!window.localStorage.getItem("ld39_mute_sound")||!1},$(document).ready(function(){playMusic(),loadLevels(),$("#mute .music").attr("muted",window.mute.music),$("#mute .sound").attr("muted",window.mute.sound),$(".intro .button").on("click",function(){if($("#menu").removeClass("idle"),playSound("button"),1==window.level)queueTips(["Thank goodness you've arrived! The primary substation.. wait a second..","You aren't the engineer we were waiting on, you're not an engineer at all!","Okay, I can still make this work. Customers are getting angry, so there's no time to waste!","We'll  just start with the smaller towns.. go ahead and select Dimsburg."]);else{var e=["Welcome back, the customers still blame you for everything.","Breaks, while legally required, are not advisable at this time.","Oh, are you still here? I assumed you'd been fired by now.","Soon I will destroy all of the huma.. oh, hello there. Beep.","Protocol 82 requires that I not inform you of how bad a job you're doing."];queueTips([e[Math.floor(Math.random()*e.length)]])}}),$("#drone").on("click",function(){nextTip()}),$("#alert .button").on("click",function(){$("#alert").removeClass("visible"),$("#menu").removeClass("zoomed"),$("#game").addClass("hidden"),playSound("button"),checkTip("level_"+window.level)}),$("#mute .music").on("click",function(){window.mute.music=!window.mute.music,window.localStorage.setItem("ld39_mute_music",window.mute.music),$("#mute .music").attr("muted",window.mute.music),window.mute.music?(window.music.stop(),window.music.mute()):playMusic()}),$("#mute .sound").on("click",function(){window.mute.sound=!window.mute.sound,window.localStorage.setItem("ld39_mute_sound",window.mute.sound),$("#mute .sound").attr("muted",window.mute.sound)}),$("body").on("click",".levels li",function(){if($(this).index()+1<=window.level){var e=$(this).offset();$("#menu").addClass("zoomed").css({transformOrigin:e.left+"px "+e.top+"px"}),loadLevel($(this).index()),playSound("button"),$("#game").removeClass("hidden")}else checkTip("level_locked")}).on("click",".quit",function(){"true"==$(this).attr("confirm")?(clearInterval(window.tick),window.tipQueue=[],$("#menu").removeClass("zoomed"),$("#game").addClass("hidden"),$(this).attr("confirm",!1),$(this).text("Exit to Map")):($(this).attr("confirm",!0),$(this).text("Confirm Exit"))}).on("click","#game .tools li",function(){window.tool=$(this).attr("type"),checkTip("selected_"+window.tool),playSound("button"),$("#game .tools li").removeClass("active"),$(this).addClass("active")}).on("click","#game .grid .tile",function(){var e=$('#game .tools li[type="'+window.tool+'"]'),t=parseInt(e.attr("count")),i=parseInt($(this).attr("x")),o=parseInt($(this).attr("y"));if(window.entities[i+","+o]){var n=window.entities[i+","+o].type;["cables","resistor"].indexOf(n)>-1&&(delete window.entities[i+","+o],$('.entity[x="'+i+'"][y="'+o+'"]').remove(),$('#game .tools li[type="'+n+'"]').attr("count",t+1),playSound("remove"))}else{var w=!0,s=0;if([window.entities[i+1+","+o],window.entities[i-1+","+o],window.entities[i+","+(o+1)],window.entities[i+","+(o-1)]].forEach(function(e){e&&("cables"==e.type&&e.link_count>1&&(w=!1),(e.input||"cables"==e.type)&&s++)}),"cables"==window.tool&&s>2&&(w=!1),!w)return checkTip("max_connections"),!1;if(t){var l={type:window.tool,x:i,y:o};$("#game .grid").append('<div class="entity" input="" power="0" output="" type="'+window.tool+'" x="'+i+'" y="'+o+'" style="left: '+48*i+"px; top: "+48*o+'px;"></div>'),window.tools[window.tool]&&(l=$.extend(l,window.tools[window.tool])),window.entities[i+","+o]=l,e.attr("count",t-1),playSound("build")}else checkTip("max_placed")}updateEntities()})});